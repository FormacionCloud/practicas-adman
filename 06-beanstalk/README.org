* Despliegue de aplicaciones con AWS Beanstalk
#+begin_quote
[!important]
Esta práctica la realizaremos en la *Landing Zone*. 
#+end_quote

En esta práctica realizaremos un despliegue de una aplicación *NodeJS* en AWS Beanstalk.

* Creación de una aplicación y entorno Beanstalk
1. En primer lugar, crearemos un entorno Beanstalk junto con su aplicación correspondiente. Para ello, accede al servicio Beanstalk, sección *Environments*, y pulsa en el botón *Create environment*.
2. En *Environment Tier*, selecciona *Web server environment*.
3. El nombre de la aplicación y el nombre del entorno deben incluir tu *nombre y apellidos*.
   [[./imagenes/01.png]]
4. Como *plataforma* de aplicación, elige la última versión de *NodeJS*.
5. A la hora de seleccionar el *código*, elegiremos desplegar la *aplicación de prueba*.
6. En los ajustes *Presets*, selecciona *Single instance*.
   [[./imagenes/02.png]]
7. Deberás crear *dos roles* (puedes hacerlo desde el propio asistente de Beanstalk, dejando los permisos que se proponen por defecto):
  [[ ./imagenes/03.png]]
   - El rol para que Beanstalk pueda desplegar los recursos
     [[./imagenes/04.png]]
   - El rol que se utilizará como *perfil de instancia* de las instancias que lanzará Beanstalk
     [[./imagenes/05.png]]
8. Selecciona una VPC con una subred pública como mínimo (no utilizaremos balanceadores de carga, solo instancias únicas, así que deben ser accesibles por IP pública). Si no tienes ninguna, créala.
   [[./imagenes/06.png]]
9. No crees base de datos, no la utilizaremos.
10. Asigna un disco SSD de 10GB para las instancias:
    [[./imagenes/07.png]]
11. Deja el resto de opciones por defecto y pulsa el botón *Create*.

Para terminar, pasados unos minutos, cuando el entorno esté en estado *Healthy*, accede a la URL de la aplicación y comprueba que se muestra la aplicación de ejemplo de AWS.

[[./imagenes/08.png]]

** Comprobación de la infraestructura creada por Beanstalk
Accede a la consola de EC2. Comprueba que se ha creado una *máquina virtual* automáticamente. Dicha máquina estará gestionada por el servicio Beanstalk. De esta manera, solo deberemos preocuparnos del código de la aplicación: toda la *infraestructura* estará *gestionada* automáticamente por *AWS* a través de Beanstalk.

[[./imagenes/09.png]]

Este es la función principal de Beanstalk: proporcionar un *nivel de abstracción superior* para simplificar el *despliegue de aplicaciones* en un modelo de *Plataforma como Servicio*.

* Actualización del código a través de la consola de AWS
En este apartado sustituiremos el código de la aplicación de ejemplo de AWS por la aplicación NodeJS de este repositorio.

** Funcionamiento de la aplicación
En primer lugar, inspecciona el archivo ~index.js~ incluido en la carpeta de proyecto del repositorio. Presta especial atención a la línea siguiente:

#+begin_src js
  // Puerto de escucha
  var port = process.env.PORT || 3000;
#+end_src

Esa línea define el puerto de escucha de nuestra aplicación. Como puedes comprobar, la variable ~port~ almacenará el valor de ~process.env.PORT~, que hace referencia a la *variable de entorno* ~PORT~ definida en el entorno de Beanstalk, de acuerdo con la [[https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/create_deploy_nodejs.container.html#nodejs-platform-console][documentación oficial]]; si no existiera dicha variable, utilizaría el puerto 3000 (útil para testeo de la aplicación en equipo local, fuera del entorno de Beanstalk).

Al crear la infraestructura necesaria para la aplicación web, Beanstalk redirigirá el tráfico de la URL de la aplicación a un puerto específico de la máquina EC2 que sirva el tráfico. Dicho puerto es referenciado por esa variable de entorno.

Por último, comentar que la aplicación escucha en 3 rutas en su URL:
1. ~/~ - Ruta raíz. Muestra un mensaje con un texto genérico del tipo "Hola mundo".
2. ~/adios~ - Muestra un mensaje con un texto genérico del tipo "Adiós mundo". En principio está comentada, por lo que no es funcional. Más adelante descomentaremos este código.
3. ~/parametro~ - Mostrará el contenido de un parámetro de Systems Manager Parameter Store. Más adelante entraremos en más detalles.

** Descarga y actualización del código de manera manual
Clona el repositorio en tu equipo de trabajo si no lo has hecho ya. Accede a la carpeta del proyecto (~practicas-adman/06-beanstalk~) y comprime el contenido de dicha carpeta.

#+begin_quote
[!WARNING]
Recuerda que debes comprimir el *contenido de la carpeta* ~practicas-adman/06-beanstalk~, no la carpeta en sí. En la raíz del ZIP debe aparecer el fichero ~index.js~, no debe aparecer una carpeta en su interior.
#+end_quote

A continuación, accede al entorno de Beanstalk y sube el ZIP creado.

[[./imagenes/10.png]]

Espera un tiempo, refresca la URL de la aplicación y comprueba que se muestra la web del proyecto.

[[./imagenes/11.png]]

* Actualización del código a través de la línea de comando
Si accedes al enlace que pone *Despedida*, verás que no funciona. En este apartado realizaremos una corrección del código y procederemos a desplegar la aplicación corregida.

** Preparación previa
Para evitar instalar todas las dependencias en nuestro equipo, utilizaremos el servicio *CloudShell* de AWS, que ya incorpora los comandos ~git~, ~npm~, ~aws~ y ~eb~.

Deberemos clonar el repositorio en CloudShell mediante el siguiente comando:
#+begin_src bash
git clone https://github.com/FormacionCloud/practicas-adman.git 
#+end_src

#+begin_quote
[!WARNING]
Si ya has clonado el repositorio anteriormente, en lugar de clonarlo deberás actualizar los cambios situándote en la carpeta del repositorio y ejecutando ~git pull~.
#+end_quote

A continuación, sitúate en la carpeta del proyecto (~practicas-adman/06-beanstalk~) y ejecuta el siguiente comando:
#+begin_src bash
  eb init
#+end_src

Responde a las preguntas que te indique:
1. Selecciona la región apropiada
2. Elige la opción que haga referencia a la aplicación Beanstalk que tengas creada

Verás que al finalizar, se crea una carpeta oculta denominada ~.elasticbeanstalk~. En ella se almacena la configuración del entorno para que futuras ejecuciones del comando ~eb~ puedan acceder a los datos del entorno correcto.

** Actualización de cambios y despliegue de la aplicación
Edita el fichero ~index.js~ (mediante el editor de tu elección, como por ejemplo ~nano~). Realiza los siguientes *cambios*:
1. Descomenta el código señalado como ~TODO~ en la ruta ~/adios~.
2. Modifica la línea señalada como ~TODO~ que hace referencia a *TUS_INICIALES* y sustituye TUS_INICIALES por tus iniciales reales, para hacer referencia al parámetro existente.
2. Modifica la línea señalada como ~TODO~ que hace referencia a *TU_REGION* y sustituye TU_REGION por la región donde estés trabajando.

A continuación, guarda los cambios en el fichero.

Seguidamente, ejecuta el siguiente comando para desplegar la aplicación actualizada:
#+begin_src bash
  eb deploy
#+end_src

Verás que la línea de comandos de Beanstalk realiza una serie de tareas para desplegar la aplicación:
1. Comprimir el contenido de la carpeta del proyecto
2. Seleccionar la aplicación y el entorno
3. Subir el fichero ZIP con los cambios del código de la aplicación
4. Reiniciar el entorno para que el nuevo código se ejecute correctamente

** Comprobación de resultados
Accede a la URL de la aplicación desplegada. Accede al enlace con el texto *Despedida* y comprueba que funciona correctamente.

* Acceso a servicios de AWS a través del SDK
En este apartado veremos cómo acceder mediante el SDK de JavaScript de AWS al servicio de Systems Manager Parameter Store. Para ello, utilizaremos el *parámetro creado* en la *práctica de secretos del módulo de Sistemas y Almacenamiento*.

#+begin_quote
[!TIP]
Si no has hecho esa práctica o ya has borrado el parámetro, crea uno nuevo con nombre ~/practica-secretos/TUS_INICIALES/param1~, cambiando TUS_INICIALES por tus iniciales reales. Tienes las instrucciones en el enunciado de dicha práctica, en su repositorio en GitHub.
#+end_quote

En el archivo ~index.js~, en el gestor de la ruta ~/parametro~, tienes el código convenientemente explicado. Verás que el código de la aplicación construye una petición para interactuar con el servicio de Systems Manager Parameter Store y mostrar el resultado de dicha petición.

Accede a la URL de la aplicación y pulsa en el enlace con texto *Parámetro de SSM*. Verás que navegas a la ruta ~/parametro~. Comprueba qué mensaje se muestra y responde a las siguientes preguntas:

1. ¿Se muestra el valor del parámetro?
2. En caso contrario, ¿cuál puede ser el motivo?
3. Si no se muestra el valor esperado, intenta resolver el problema y explica los pasos seguidos.

#+begin_quote
[!TIP]
Parece que es un problema de permisos, ¿verdad? Recuerda que hemos creado dos roles en esta práctica. ¿Crees que alguno de ellos está relacionado con este tema?

Recuerda también que el código de la aplicación se está ejecutando desde una máquina EC2.
#+end_quote

* Eliminación del entorno de Beanstalk
Desde CloudShell, en la carpeta del proyecto, ejecuta el siguiente comando para eliminar el entorno:

#+begin_src bash
  eb terminate
#+end_src

* Entrega
Documenta la realización de la práctica explicando los pasos seguidos. Incluye las *capturas de pantalla* necesarias. Recuerda mostrar tus datos personales (nombre y apellidos y/o iniciales) en aquellos apartados donde se indique.

* Limpieza
Al finalizar, asegúrate que el entorno de Beanstalk se ha eliminado correctamente, para no incurrir en gastos innecesarios.
